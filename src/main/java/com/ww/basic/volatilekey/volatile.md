# Volatile

## CPU术语

* 内存屏障（memory barriers）

  是一组处理器指令，用于实现对内存操作的顺序限制；

* 缓冲行（cache line）

  缓存中可以分配的最小存储单位，处理器填写缓存线时会加载整个缓存线，需要使用多个主内存读周期；

* 缓存行填充（cache line fill）

  当处理器识别到从内存中读取操作数是可缓存的，处理器读取整个缓存行到适当的缓存（L1，L2，L3或所有）；

* 写命中（write hit）

  当处理器将操作数写回到一个内存缓存的区域时，它首先会检查这个缓存的内存地址是否在缓存行中，如果存在一个有效的缓存行，则处理器将这个操作数写回到缓存，而不是写回到内存，这个操作被称为写命中；

* 写缺失（write misses the cache）

  一个有效的缓存行被写入到不存在的内存区域

  ## Volatile是如何保证可见性的

  ```java
  instance = new Singleton(); // instance是volatile变量
  ```

  转变成汇编代码

  ```assembly
  0x01a3de1d: movb $0x0, 0x1104800(%esi);0x01a3de24: lock add1 $0x0,(%esp);
  ```

  Lock前缀的指令在多核处理器下会引发两件事：

  ①将当前处理器缓存行的数据写回到系统内存；

  ​	缓存一致性机制会阻止同时修改由两个以上处理器缓存的内存区域数据。

  ②这个写回内存的操作会使在其他CPU里缓存了该内存地址的数据无效；

  IA-32处理器和Intel64处理器使用MESI（修改、独占、贡献、无效）控制协议去维护内部缓存和其他处理器缓存的一致性。在多核处理器系统中进行操作的时候，IA-32和Intel64处理器能嗅探其他处理器访问系统内存和他们的内部缓存。处理器使用嗅探技术保证它的内部缓存、系统内存和其他处理器的缓存的数据在总线上保持一致。

